<!DOCTYPE html>
<html lang="en">
    <head>
        <style type="text/css">
            .hovered{
                cursor: pointer;
            }

            #watermark {
              color: #d0d0d0;
              font-size: 200pt;
              -webkit-transform: rotate(-45deg);
              -moz-transform: rotate(-45deg);
              position: absolute;
              width: 100%;
              height: 100%;
              margin: 0;
              z-index: -1;
              left:-100px;
              top:-200px;
            }
        </style>
    </head>
    <body>
        <div id="fb-root"></div>

        <div id="watermark">
        <p></p>
        </div>

        <div class="container-fluid">
            <canvas id="viewport" width="1500" height="1000"></canvas>
        </div>

        <script src="http://connect.facebook.net/en_US/all.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/arbor.js"></script> 
        <script src="js/arbor-tween.js"></script>   
        <script src="js/graphics.js"></script>  
        <script src="js/renderer.js"></script>
        <script type="text/javascript">
            FB.init({
                appId: '351583388282176',
                status: true,
                cookie: true,
                oauth: true
            });

            $(document).ready(function() {
                var sys = arbor.ParticleSystem(1000, 600, 0.5) // create the system with sensible repulsion/stiffness/friction
                sys.parameters({gravity:false}) // use center-gravity to make the graph settle nicely (ymmv)
                sys.renderer = Renderer("#viewport") // our newly created renderer will have its .init() method called shortly by sys...
                
                FB.getLoginStatus(function(stsResp) {
                    if(stsResp.authResponse) {
                        getUserInfo(sys, 1002388, "Audrey");
                    } else {
                        FB.login(function(loginResp) {
                            if(loginResp.authResponse) {
                                getUserInfo(sys, 1002388, "Audrey");
                            } else {
                                alert('Please authorize this application to use it!');
                            }
                        });
                    }
                });
            });

            var userData = null;

            function getUserInfo(sys, id, name) {
                var url;
                if(id) {
                    url = 'me/mutualfriends/' + id
                    $("p").html(name)
                    console.log("got an id")
                }
                else url = 'me/mutualfriends/1002388'

                FB.api(url, function(response) {
                    var friends = new Array();
                    for(var i=0; i < response.data.length; i++) {
                        (function(){
                            var k = i;
                            friends.push(response.data[i].id);

                            FB.api(response.data[i].id + '/picture?type=square', function(res){
                                sys.addNode(response.data[k].id, {label:response.data[k].name, color:'1D4D80', url:res.data.url})
                                console.log('node added')
                            });
                         })();
                    }

                    var len = friends.length;
                    var returnedCallsCounter = 0;

                    for(var j=0; j < len; j++) {
                        (function(){
                            var k = j;
                            var req = 'me/mutualfriends/' + friends[j];
                        
                            FB.api(req, function(resp){
                              //  returnedCallsCounter++;
                             //   if(returnedCallsCounter == len) {
                                    for(var i=0; i < resp.data.length; i++) {
                                        if(jQuery.inArray(resp.data[i].id, friends) >= 0) {
                                            if(sys.getEdges(friends[k], resp.data[i].id).length === 0){
                                                sys.addEdge(friends[k], resp.data[i].id, {directed:false})
                                            }
                                        }
                                    }
                             //   }
                            });
                        })();
                    }
                });
            }
        </script>
    </body>
</html>